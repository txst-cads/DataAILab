<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="1.0.0-test">
    <meta name="commit" content="abc1234">
    <title>CADS Monitoring Integration Test</title>
    
    <!-- Sentry Error Tracking -->
    <script
        src="https://browser.sentry-cdn.com/7.99.0/bundle.tracing.min.js"
        integrity="sha384-8Jhi9/2B8XUqmm8DJKvQNEow6T+TwPA18n9dTcY/4owvxl1LvdP2TzZpKKfYMb2+"
        crossorigin="anonymous"
    ></script>
    
    <!-- Vercel Analytics Mock -->
    <script>
        window.va = window.va || function () { 
            console.log('VA Track:', arguments);
            (window.vaq = window.vaq || []).push(arguments); 
        };
    </script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
        }
        
        .test-section {
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        
        .test-pass {
            background: #1b5e20;
            border: 1px solid #4caf50;
        }
        
        .test-fail {
            background: #b71c1c;
            border: 1px solid #f44336;
        }
        
        .test-warning {
            background: #e65100;
            border: 1px solid #ff9800;
        }
        
        button {
            background: #007acc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #005a9e;
        }
        
        .error-display {
            background: #d32f2f;
            color: white;
            padding: 12px 16px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
        
        pre {
            background: #333;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>üß™ CADS Monitoring Integration Test</h1>
    <p>This page tests all monitoring components for the CADS Research Visualization system.</p>
    
    <div class="test-section">
        <h2>üìä Test Results</h2>
        <div id="test-results"></div>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>
    
    <div class="test-section">
        <h2>üö® Error Testing</h2>
        <p>Test error handling and reporting:</p>
        <button onclick="triggerJavaScriptError()">Trigger JS Error</button>
        <button onclick="triggerPromiseRejection()">Trigger Promise Rejection</button>
        <button onclick="triggerResourceError()">Trigger Resource Error</button>
        <button onclick="triggerCustomError()">Trigger Custom Error</button>
    </div>
    
    <div class="test-section">
        <h2>üìà Performance Testing</h2>
        <p>Test performance monitoring:</p>
        <button onclick="testPerformanceTracking()">Test Performance Tracking</button>
        <button onclick="simulateSlowOperation()">Simulate Slow Operation</button>
        <button onclick="testMemoryUsage()">Test Memory Usage</button>
    </div>
    
    <div class="test-section">
        <h2>üë§ User Interaction Testing</h2>
        <p>Test user interaction tracking:</p>
        <button onclick="testUserInteraction()">Test User Interaction</button>
        <button onclick="testCustomEvent()">Test Custom Event</button>
    </div>
    
    <div class="test-section">
        <h2>üîç Debug Information</h2>
        <button onclick="showDebugInfo()">Show Debug Info</button>
        <div id="debug-info"></div>
    </div>
    
    <!-- Error Display -->
    <div id="error-message" class="error-display">
        <div class="error-title">Test Error</div>
        <div class="error-details" id="error-details">This is a test error message.</div>
    </div>
    
    <!-- Load monitoring scripts -->
    <script src="../monitoring/error-boundary.js"></script>
    <script src="../monitoring/release-tracking.js"></script>
    <script src="../monitoring/test_monitoring_integration.js"></script>
    
    <!-- Initialize Sentry for testing -->
    <script>
        // Initialize Sentry for testing
        if (typeof Sentry !== 'undefined') {
            Sentry.init({
                dsn: 'https://test-dsn@sentry.io/test-project', // Test DSN
                environment: 'test',
                integrations: [
                    new Sentry.BrowserTracing(),
                ],
                tracesSampleRate: 1.0, // 100% for testing
                beforeSend(event) {
                    console.log('Sentry Event:', event);
                    return event; // Allow all events in test
                },
            });
        }
        
        // Mock CADS Visualization object for testing
        window.CADSVisualization = {
            performance: {
                loadStartTime: performance.now() - 5000,
                dataLoadTime: 2500,
                renderTime: 150,
                interactionCount: 0,
                errorCount: 0
            },
            data: {
                p: new Array(100).fill(null).map((_, i) => ({ id: i, title: `Paper ${i}` })),
                r: new Array(10).fill(null).map((_, i) => ({ id: i, name: `Researcher ${i}` })),
                c: new Array(5).fill(null).map((_, i) => ({ id: i, name: `Cluster ${i}` }))
            },
            loadVisualization: function() {
                console.log('Mock loadVisualization called');
                return Promise.resolve();
            },
            initializeDeckGL: function(data) {
                console.log('Mock initializeDeckGL called with data:', data);
            }
        };
        
        // Mock tracking functions
        window.trackEvent = function(eventName, properties) {
            console.log(`üìä Track Event: ${eventName}`, properties);
            if (window.va) {
                window.va('track', eventName, properties);
            }
        };
        
        window.trackPerformance = function(metricName, value, unit) {
            console.log(`‚è±Ô∏è Track Performance: ${metricName} = ${value}${unit}`);
            window.trackEvent('Performance Metric', {
                metric: metricName,
                value: value,
                unit: unit
            });
        };
        
        window.showError = function(title, details) {
            const errorElement = document.getElementById('error-message');
            const errorDetails = document.getElementById('error-details');
            
            errorElement.querySelector('.error-title').textContent = title;
            errorDetails.textContent = details;
            errorElement.style.display = 'block';
            
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        };
    </script>
    
    <!-- Test Functions -->
    <script>
        let testResults = [];
        
        function addTestResult(testName, passed, message) {
            const result = {
                name: testName,
                passed: passed,
                message: message,
                timestamp: new Date().toISOString()
            };
            
            testResults.push(result);
            displayTestResult(result);
        }
        
        function displayTestResult(result) {
            const resultsContainer = document.getElementById('test-results');
            const resultElement = document.createElement('div');
            resultElement.className = `test-result ${result.passed ? 'test-pass' : 'test-fail'}`;
            resultElement.innerHTML = `
                <strong>${result.passed ? '‚úÖ' : '‚ùå'} ${result.name}</strong><br>
                ${result.message}<br>
                <small>${result.timestamp}</small>
            `;
            resultsContainer.appendChild(resultElement);
        }
        
        function clearResults() {
            testResults = [];
            document.getElementById('test-results').innerHTML = '';
        }
        
        // Error testing functions
        function triggerJavaScriptError() {
            console.log('Triggering JavaScript error...');
            setTimeout(() => {
                throw new Error('Test JavaScript error for monitoring');
            }, 100);
        }
        
        function triggerPromiseRejection() {
            console.log('Triggering promise rejection...');
            Promise.reject(new Error('Test promise rejection for monitoring'));
        }
        
        function triggerResourceError() {
            console.log('Triggering resource error...');
            const img = document.createElement('img');
            img.src = 'https://nonexistent-domain-for-testing.com/image.jpg';
            document.body.appendChild(img);
            setTimeout(() => document.body.removeChild(img), 1000);
        }
        
        function triggerCustomError() {
            console.log('Triggering custom error...');
            window.showError('Test Error', 'This is a test error triggered manually');
        }
        
        // Performance testing functions
        function testPerformanceTracking() {
            console.log('Testing performance tracking...');
            const startTime = performance.now();
            
            // Simulate some work
            for (let i = 0; i < 1000000; i++) {
                Math.random();
            }
            
            const duration = performance.now() - startTime;
            window.trackPerformance('test_operation', Math.round(duration), 'ms');
            
            addTestResult('Performance Tracking', true, `Tracked operation took ${Math.round(duration)}ms`);
        }
        
        function simulateSlowOperation() {
            console.log('Simulating slow operation...');
            const startTime = performance.now();
            
            setTimeout(() => {
                const duration = performance.now() - startTime;
                window.trackPerformance('slow_operation', Math.round(duration), 'ms');
                addTestResult('Slow Operation Simulation', true, `Simulated ${Math.round(duration)}ms operation`);
            }, 2000);
        }
        
        function testMemoryUsage() {
            console.log('Testing memory usage tracking...');
            
            if (performance.memory) {
                const memoryInfo = {
                    used: Math.round(performance.memory.usedJSHeapSize / 1024 / 1024),
                    total: Math.round(performance.memory.totalJSHeapSize / 1024 / 1024),
                    limit: Math.round(performance.memory.jsHeapSizeLimit / 1024 / 1024)
                };
                
                window.trackEvent('Memory Usage Test', memoryInfo);
                addTestResult('Memory Usage Tracking', true, `Used: ${memoryInfo.used}MB, Total: ${memoryInfo.total}MB`);
            } else {
                addTestResult('Memory Usage Tracking', false, 'performance.memory not available in this browser');
            }
        }
        
        // User interaction testing functions
        function testUserInteraction() {
            console.log('Testing user interaction tracking...');
            
            window.trackEvent('User Interaction', {
                interaction_type: 'test_click',
                element: 'test_button',
                timestamp: new Date().toISOString()
            });
            
            addTestResult('User Interaction Tracking', true, 'Test interaction event tracked');
        }
        
        function testCustomEvent() {
            console.log('Testing custom event tracking...');
            
            window.trackEvent('Custom Test Event', {
                test_property: 'test_value',
                number_property: 42,
                boolean_property: true,
                timestamp: new Date().toISOString()
            });
            
            addTestResult('Custom Event Tracking', true, 'Custom event with multiple property types tracked');
        }
        
        // Debug information
        function showDebugInfo() {
            const debugContainer = document.getElementById('debug-info');
            
            const debugInfo = {
                releaseInfo: window.RELEASE_INFO || 'Not available',
                errorBoundaryStats: window.errorBoundary ? window.errorBoundary.getErrorStats() : 'Not available',
                sentryHub: typeof Sentry !== 'undefined' ? 'Available' : 'Not available',
                vercelAnalytics: typeof window.va !== 'undefined' ? 'Available' : 'Not available',
                performanceAPI: typeof performance !== 'undefined' ? 'Available' : 'Not available',
                performanceMemory: typeof performance.memory !== 'undefined' ? 'Available' : 'Not available',
                performanceObserver: typeof PerformanceObserver !== 'undefined' ? 'Available' : 'Not available',
                userAgent: navigator.userAgent,
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                testResults: testResults
            };
            
            debugContainer.innerHTML = `<pre>${JSON.stringify(debugInfo, null, 2)}</pre>`;
        }
        
        // Run all tests
        function runAllTests() {
            console.log('üß™ Running all monitoring tests...');
            clearResults();
            
            // Run the imported test functions
            if (typeof runAllTests !== 'undefined') {
                try {
                    const importedResults = window.runAllTests();
                    
                    // Convert imported results to our format
                    Object.entries(importedResults).forEach(([testName, result]) => {
                        if (typeof result === 'boolean') {
                            addTestResult(testName, result, result ? 'Test passed' : 'Test failed');
                        } else if (typeof result === 'object') {
                            const passed = result.sentryLoaded || result.vercelAnalyticsLoaded || false;
                            addTestResult(testName, passed, JSON.stringify(result));
                        }
                    });
                } catch (error) {
                    addTestResult('Imported Tests', false, `Error running imported tests: ${error.message}`);
                }
            }
            
            // Run our additional tests
            setTimeout(() => {
                testPerformanceTracking();
                testUserInteraction();
                testCustomEvent();
                
                // Test error boundary
                if (window.errorBoundary) {
                    addTestResult('Error Boundary', true, 'Error boundary is initialized');
                } else {
                    addTestResult('Error Boundary', false, 'Error boundary not found');
                }
                
                // Test release tracking
                if (window.releaseTracker) {
                    addTestResult('Release Tracking', true, 'Release tracker is initialized');
                } else {
                    addTestResult('Release Tracking', false, 'Release tracker not found');
                }
            }, 500);
        }
        
        // Auto-run tests when page loads
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('üöÄ Auto-running monitoring tests...');
                runAllTests();
            }, 2000);
        });
    </script>
</body>
</html>