<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CADS Error Diagnosis</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a1a;
            color: #ffffff;
            line-height: 1.6;
        }
        
        .test-section {
            background: #2a2a2a;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .status.success {
            background: #1b5e20;
            border: 1px solid #4caf50;
        }
        
        .status.error {
            background: #b71c1c;
            border: 1px solid #f44336;
        }
        
        .status.info {
            background: #1565c0;
            border: 1px solid #2196f3;
        }
        
        pre {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            border: 1px solid #555;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üîç CADS Application Error Diagnosis</h1>
    <p>Diagnosing the application error after recent changes.</p>
    
    <div class="test-section">
        <h2>üß™ JavaScript Error Detection</h2>
        <div id="js-errors"></div>
    </div>
    
    <div class="test-section">
        <h2>üìÅ File Accessibility Test</h2>
        <div id="file-tests"></div>
    </div>
    
    <div class="test-section">
        <h2>üîß Element Availability Test</h2>
        <div id="element-tests"></div>
    </div>
    
    <div class="test-section">
        <h2>üìä Console Logs</h2>
        <pre id="console-logs">Waiting for logs...</pre>
    </div>
    
    <div class="test-section">
        <h2>üöÄ Quick Fix Test</h2>
        <div id="fix-test">
            <button onclick="testMainApp()" style="background: #007acc; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
                Test Main Application
            </button>
        </div>
    </div>
    
    <script>
        let logs = [];
        let errors = [];
        
        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        
        console.log = function(...args) {
            logs.push(`LOG: ${args.join(' ')}`);
            updateConsoleLogs();
            originalLog.apply(console, args);
        };
        
        console.error = function(...args) {
            errors.push(`ERROR: ${args.join(' ')}`);
            updateConsoleLogs();
            originalError.apply(console, args);
        };
        
        function updateConsoleLogs() {
            const logsElement = document.getElementById('console-logs');
            const allLogs = [...logs, ...errors].slice(-20); // Show last 20 entries
            logsElement.textContent = allLogs.join('\n') || 'No logs yet...';
        }
        
        function addResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<strong>${message}</strong><br><small>${new Date().toLocaleTimeString()}</small>`;
            container.appendChild(div);
        }
        
        // Global error handler
        window.addEventListener('error', (event) => {
            addResult('js-errors', `JavaScript Error: ${event.message} at ${event.filename}:${event.lineno}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            addResult('js-errors', `Promise Rejection: ${event.reason}`, 'error');
        });
        
        function testFiles() {
            const files = [
                '../public/index.html',
                '../public/app.js',
                '../public/cads_logo.png',
                '../public/data/visualization-data.json'
            ];
            
            files.forEach(file => {
                fetch(file)
                    .then(response => {
                        if (response.ok) {
                            addResult('file-tests', `‚úÖ ${file} - Accessible`, 'success');
                        } else {
                            addResult('file-tests', `‚ùå ${file} - HTTP ${response.status}`, 'error');
                        }
                    })
                    .catch(error => {
                        addResult('file-tests', `‚ùå ${file} - ${error.message}`, 'error');
                    });
            });
        }
        
        function testElements() {
            // Test if main app would have required elements
            const requiredElements = [
                'map-container',
                'ui-panel',
                'researcher-input',
                'theme-checklist',
                'year-filter'
            ];
            
            // Create a temporary iframe to test the main page
            const iframe = document.createElement('iframe');
            iframe.src = '../public/index.html';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            iframe.onload = function() {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    
                    requiredElements.forEach(elementId => {
                        const element = iframeDoc.getElementById(elementId);
                        if (element) {
                            addResult('element-tests', `‚úÖ Element #${elementId} found`, 'success');
                        } else {
                            addResult('element-tests', `‚ùå Element #${elementId} missing`, 'error');
                        }
                    });
                    
                    // Check for JavaScript errors in the iframe
                    const scripts = iframeDoc.querySelectorAll('script');
                    addResult('element-tests', `üìÑ Found ${scripts.length} script tags`, 'info');
                    
                } catch (error) {
                    addResult('element-tests', `‚ùå Cannot access iframe content: ${error.message}`, 'error');
                }
                
                document.body.removeChild(iframe);
            };
            
            iframe.onerror = function() {
                addResult('element-tests', '‚ùå Failed to load main application in iframe', 'error');
                document.body.removeChild(iframe);
            };
        }
        
        function testMainApp() {
            addResult('fix-test', 'Opening main application in new tab...', 'info');
            const newWindow = window.open('../public/index.html', '_blank');
            
            if (newWindow) {
                addResult('fix-test', '‚úÖ Main application opened - check for errors in new tab', 'success');
            } else {
                addResult('fix-test', '‚ùå Failed to open main application (popup blocked?)', 'error');
            }
        }
        
        // Run tests when page loads
        window.addEventListener('load', () => {
            console.log('üîç Starting error diagnosis...');
            
            setTimeout(() => {
                testFiles();
                testElements();
            }, 500);
        });
    </script>
</body>
</html>